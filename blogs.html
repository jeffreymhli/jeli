<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jeffrey Ming Han Li | Blogs</title>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">Jeffrey Ming Han Li</div>
    <nav class="topnav">
      <a href="index.html#about" class="jump-btn">About</a>
      <!-- <a href="index.html#research" class="jump-btn">Research</a> -->
      <a href="index.html#publications" class="jump-btn">Publications</a>
      <a href="index.html#experience" class="jump-btn">Experience</a>
      <a href="blogs.html" class="jump-btn">Blogs</a>
      <a href="notes.html" class="jump-btn">Notes</a>
    </nav>
  </header>

  <main class="page-wrap">
    <section class="content-section">
      <h1>Blogs</h1>
      <p class="lead">This page auto-loads posts from <code>content/blogs.json</code> (generated from <code>blogs/</code>).</p>
      <div class="blog-controls">
        <label class="blog-search-wrap" for="blog-search">
          <span>Search</span>
          <input id="blog-search" type="search" placeholder="Search title, date, or tags..." autocomplete="off">
        </label>
        <div class="blog-tag-row" id="blog-tags"></div>
      </div>
      <div class="cards" id="blog-list"></div>
      <p class="empty-state" id="blog-empty" hidden>No blog posts found in <code>blogs/</code>.</p>
    </section>
  </main>
  <script>
    const state = {
      posts: [],
      filtered: [],
      query: "",
      activeTags: new Set()
    };

    function escapeHtml(value) {
      return String(value ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizeTagList(tags) {
      if (!Array.isArray(tags)) return [];
      return tags
        .map((tag) => String(tag).trim())
        .filter((tag) => tag.length > 0);
    }

    function postSearchBlob(post) {
      const tags = normalizeTagList(post.tags);
      return [
        post.title || "",
        post.description || "",
        post.date || "",
        ...tags
      ].join(" ").toLowerCase();
    }

    function applyFilters() {
      const q = state.query.trim().toLowerCase();
      state.filtered = state.posts.filter((post) => {
        const tags = normalizeTagList(post.tags);
        const matchesQuery = !q || postSearchBlob(post).includes(q);
        const matchesTags = state.activeTags.size === 0 || Array.from(state.activeTags).every((tag) => tags.includes(tag));
        return matchesQuery && matchesTags;
      });
      renderPostCards(state.filtered);
    }

    function renderTagFilters(posts) {
      const row = document.getElementById("blog-tags");
      const allTags = Array.from(
        new Set(posts.flatMap((post) => normalizeTagList(post.tags)))
      ).sort((a, b) => a.localeCompare(b));

      if (!allTags.length) {
        row.innerHTML = "";
        return;
      }

      row.innerHTML = `
        <span class="blog-tag-label">Tags</span>
        ${allTags.map((tag) => `
          <button type="button" class="blog-tag-filter ${state.activeTags.has(tag) ? "is-active" : ""}" data-tag="${escapeHtml(tag)}">${escapeHtml(tag)}</button>
        `).join("")}
      `;

      row.querySelectorAll(".blog-tag-filter").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tag = btn.dataset.tag;
          if (!tag) return;
          if (state.activeTags.has(tag)) {
            state.activeTags.delete(tag);
          } else {
            state.activeTags.add(tag);
          }
          renderTagFilters(state.posts);
          applyFilters();
        });
      });
    }

    function renderPostCards(posts) {
      const listEl = document.getElementById("blog-list");
      const emptyEl = document.getElementById("blog-empty");
      if (!posts.length) {
        listEl.innerHTML = "";
        emptyEl.hidden = false;
        emptyEl.textContent = "No posts match your search/filter.";
        return;
      }
      emptyEl.hidden = true;
      emptyEl.textContent = "No blog posts found in blogs/.";
      listEl.innerHTML = posts
        .map((post) => {
          const tags = normalizeTagList(post.tags);
          return `
            <article class="card">
              <span class="meta-line">${escapeHtml(post.date || post.path || "")}</span>
              <h3>${escapeHtml(post.title || "Untitled Post")}</h3>
              <p>${escapeHtml(post.description || "Auto-detected from the blogs folder.")}</p>
              ${tags.length ? `<div class="post-tag-list">${tags.map((tag) => `<span class="post-tag">${escapeHtml(tag)}</span>`).join("")}</div>` : ""}
              <a href="${escapeHtml(post.path || "#")}" class="read-btn">Read Post</a>
            </article>
          `;
        })
        .join("");
    }

    async function fetchJsonWithFallback(paths) {
      for (const path of paths) {
        try {
          const response = await fetch(path);
          if (!response.ok) continue;
          const data = await response.json();
          return data;
        } catch {}
      }
      return null;
    }

    async function listDirectoryFiles(directory, extension) {
      const response = await fetch(directory);
      if (!response.ok) return [];
      const html = await response.text();
      const doc = new DOMParser().parseFromString(html, "text/html");
      const anchors = Array.from(doc.querySelectorAll("a[href]"));
      return anchors
        .map((a) => a.getAttribute("href"))
        .filter((href) => href && href.toLowerCase().endsWith(extension))
        .map((href) => decodeURIComponent(href))
        .filter((href) => !href.includes("/"));
    }

    function titleFromFilename(filename) {
      return filename
        .replace(/\.html$/i, "")
        .replace(/[-_]+/g, " ")
        .replace(/\b\w/g, (c) => c.toUpperCase());
    }

    async function renderBlogs() {
      const emptyEl = document.getElementById("blog-empty");
      try {
        const raw = await fetchJsonWithFallback([
          "content/blogs.json",
          "./content/blogs.json",
          "/content/blogs.json"
        ]);
        if (!raw) {
          const files = await listDirectoryFiles("blogs/", ".html");
          const fallbackPosts = files.map((file) => ({
            path: `blogs/${file}`,
            title: titleFromFilename(file),
            description: "HTML blog post",
            tags: []
          }));
          if (!fallbackPosts.length) {
            throw new Error("No JSON index or directory listing.");
          }
          state.posts = fallbackPosts;
          renderTagFilters(state.posts);
          applyFilters();
          return;
        }
        const posts = Array.isArray(raw) ? raw : (raw ? [raw] : []);
        if (!posts.length) {
          emptyEl.hidden = false;
          return;
        }
        state.posts = posts.map((post) => ({
          ...post,
          tags: normalizeTagList(post.tags)
        }));
        renderTagFilters(state.posts);
        applyFilters();
      } catch {
        emptyEl.hidden = false;
        emptyEl.textContent = "Could not load blog list. Make sure you started the server at repo root.";
      }
    }

    document.getElementById("blog-search").addEventListener("input", (event) => {
      state.query = event.target.value || "";
      applyFilters();
    });

    renderBlogs();
  </script>
</body>
</html>
